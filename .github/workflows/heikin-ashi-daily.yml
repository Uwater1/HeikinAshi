name: HeikinAshi daily run

on:
  # daily at 03:00 UTC (quiet time)
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  run-if-heikinashi-changed:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set DATE environment variable (UTC YYYY-MM-DD)
        run: echo "DATE=$(date -u +%F)" >> $GITHUB_ENV

      - id: check
        name: Check whether heikinAshi.py was changed today (UTC)
        run: |
          # Ensure we have refs and full history
          git fetch --no-tags --prune || true

          # Use UTC midnight today as the "since" boundary
          SINCE="$(date -u '+%Y-%m-%dT00:00:00Z')"
          echo "Checking commits since $SINCE for changes to heikinAshi.py"

          # Search commits since midnight UTC for file named exactly "heikinAshi.py"
          if git log --since="$SINCE" --name-only --pretty=format: | grep -q '^heikinAshi.py$'; then
            echo "heikinAshi.py changed since $SINCE"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "no change to heikinAshi.py since $SINCE"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python (only if changed)
        if: steps.check.outputs.changed == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies (only if changed and requirements.txt exists)
        if: steps.check.outputs.changed == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found; skipping pip install"
          fi

      - name: Run heikinAshi.py (only if changed)
        if: steps.check.outputs.changed == 'true'
        run: |
          # Fail fast if script or data missing
          if [ ! -f heikinAshi.py ]; then
            echo "heikinAshi.py not found" >&2
            exit 1
          fi
          if [ ! -f IVV.csv ]; then
            echo "IVV.csv not found" >&2
            exit 1
          fi

          # Run the script, capture stdout to dated .txt
          python heikinAshi.py IVV.csv > heikinAshi_${DATE}.txt
          echo "Wrote heikinAshi_${DATE}.txt"

          # Preserve any generated .html files by copying them to include the DATE suffix,
          # but only if they don't already contain the DATE to avoid duplicates.
          shopt -s nullglob
          html_files=( *.html )
          if [ ${#html_files[@]} -gt 0 ]; then
            for f in "${html_files[@]}"; do
              # Skip if filename already contains the DATE
              if [[ "$f" == *"${DATE}"* ]]; then
                echo "Skipping $f (already contains date)"
                continue
              fi
              dest="${f%.*}_${DATE}.html"
              cp "$f" "$dest"
              echo "Copied $f to $dest for artifact preservation"
            done
          else
            echo "No .html files found to preserve"
          fi

      - name: Write job summary (only if changed)
        if: steps.check.outputs.changed == 'true'
        run: |
          # $GITHUB_STEP_SUMMARY is a file path provided by GitHub Actions.
          # Appending a small markdown summary here makes results visible in the "Job summary" UI.
          echo "## HeikinAshi run summary for ${DATE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Generated files:" >> $GITHUB_STEP_SUMMARY

          if [ -f heikinAshi_${DATE}.txt ]; then
            echo "  - heikinAshi_${DATE}.txt" >> $GITHUB_STEP_SUMMARY
          else
            echo "  - (no text output)" >> $GITHUB_STEP_SUMMARY
          fi

          shopt -s nullglob
          html_files=( *_${DATE}.html *.html )
          if [ ${#html_files[@]} -gt 0 ]; then
            for f in "${html_files[@]}"; do
              echo "  - ${f}" >> $GITHUB_STEP_SUMMARY
            done
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key output (first 200 lines of heikinAshi_${DATE}.txt)" >> $GITHUB_STEP_SUMMARY
          if [ -f heikinAshi_${DATE}.txt ]; then
            # Indent block so it renders as code in the summary
            head -n 200 heikinAshi_${DATE}.txt | sed 's/^/    /' >> $GITHUB_STEP_SUMMARY
          else
            echo "_no text output_" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Print generated files to workflow logs (only if changed)
        if: steps.check.outputs.changed == 'true'
        run: |
          # Printing the main outputs into the workflow logs makes them available in the run logs
          # (useful if you want to avoid downloading artifacts).
          echo "=== Begin heikinAshi_${DATE}.txt (showing up to 500 lines) ==="
          if [ -f heikinAshi_${DATE}.txt ]; then
            sed -n '1,500p' heikinAshi_${DATE}.txt
          else
            echo "(no text output)"
          fi
          echo "=== End heikinAshi_${DATE}.txt ==="

          shopt -s nullglob
          for f in *_${DATE}.html *.html; do
            echo "=== Begin $f (showing up to 200 lines) ==="
            sed -n '1,200p' "$f" || echo "(unable to print $f)"
            echo "=== End $f ==="
          done

      - name: Upload generated files as workflow artifact (only if changed)
        if: steps.check.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: heikinAshi-${{ env.DATE }}
          path: |
            heikinAshi_${{ env.DATE }}.txt
            *.html

      # Optional: commit the generated file back to the repository.
      # WARNING: enabling this will make the workflow push to the default branch.
      # Uncomment and configure if you want the output committed automatically.
      # - name: Commit and push generated file back to repo (optional)
      #   if: steps.check.outputs.changed == 'true'
      #   run: |
      #     git config user.name "github-actions[bot]"
      #     git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      #     git add heikinAshi_${DATE}.txt
      #     git commit -m "Add heikinAshi output for ${DATE} [ci skip]" || echo "Nothing to commit"
      #     git push origin "HEAD:refs/heads/${GITHUB_REF#refs/heads/}"
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
